name: Ubuntu Fast RDP

on:
  workflow_dispatch:

jobs:
  secure-remote:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: 1. Silent Install Essentials
        run: |
          # Force non-interactive and auto-accept service restarts
          export DEBIAN_FRONTEND=noninteractive
          export NEEDRESTART_MODE=a
          
          sudo apt-get update
          sudo apt-get install -y -q --no-install-recommends \
            xfce4 xfce4-goodies xrdp dbus-x11 pulseaudio

      - name: 2. Configure User & Force Desktop Session
        run: |
          # Create user Rayat
          sudo useradd -m -s /bin/bash Rayat
          echo "Rayat:password123" | sudo chpasswd
          sudo usermod -aG sudo Rayat
          
          # Fix Permission Denied: Write to temp then move with sudo
          echo "xfce4-session" > xsession_tmp
          sudo mv xsession_tmp /home/Rayat/.xsession
          sudo chown Rayat:Rayat /home/Rayat/.xsession
          
          # Fix Teal Screen: Rewrite startwm.sh to launch XFCE directly
          # This replaces the entire script with a clean launch command
          sudo bash -c 'cat > /etc/xrdp/startwm.sh <<EOF
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi
          exec startxfce4
          EOF'
          sudo chmod +x /etc/xrdp/startwm.sh
          
          # Add XRDP to security groups
          sudo adduser xrdp ssl-cert
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: 3. Install and Connect Tailscale
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key=$TS_KEY --hostname=gh-ubuntu-runner
          
          # Capture IP for the connection banner
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: 4. RDP Connection Ready
        run: |
          echo "=========================================="
          echo "STATUS: RDP SERVER ACTIVE"
          echo "ADDRESS: ${{ env.TAILSCALE_IP }}"
          echo "USER: Rayat"
          echo "PASS: password123"
          echo "=========================================="
          # Keep the runner alive indefinitely
          tail -f /dev/null
