name: Ubuntu Fast RDP

on:
  workflow_dispatch:

jobs:
  secure-remote:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: 1. Silent Install Essentials
        run: |
          export DEBIAN_FRONTEND=noninteractive
          export NEEDRESTART_MODE=a
          sudo apt-get update
          sudo apt-get install -y -q --no-install-recommends \
            xfce4 xfce4-goodies xrdp dbus-x11 pulseaudio x11-xserver-utils

      - name: 2. Configure User & Nuclear Desktop Force
        run: |
          # Create user Rayat
          sudo useradd -m -s /bin/bash Rayat
          echo "Rayat:password123" | sudo chpasswd
          sudo usermod -aG sudo Rayat
          
          # Force XFCE session with D-Bus support
          # Using dbus-launch ensures the desktop actually starts
          echo "exec dbus-launch --exit-with-session startxfce4" > xsession_tmp
          sudo mv xsession_tmp /home/Rayat/.xsession
          sudo chown Rayat:Rayat /home/Rayat/.xsession
          
          # Wipe and replace startwm.sh completely
          sudo bash -c 'cat > /etc/xrdp/startwm.sh <<EOF
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi
          # Ensure environment is clean
          unset DBUS_SESSION_BUS_ADDRESS
          unset XDG_RUNTIME_DIR
          . /etc/X11/Xsession
          EOF'
          sudo chmod +x /etc/xrdp/startwm.sh

          # Fix XRDP Permissions
          sudo adduser xrdp ssl-cert
          sudo systemctl restart xrdp

      - name: 3. Install and Connect Tailscale
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key=$TS_KEY --hostname=gh-ubuntu-runner
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      - name: 4. RDP Connection Ready
        run: |
          echo "=== CONNECT NOW ==="
          echo "Address: ${{ env.TAILSCALE_IP }}"
          echo "Username: Rayat"
          echo "Password: password123"
          tail -f /dev/null
