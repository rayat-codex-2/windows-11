name: Ubuntu Desktop Remote

on:
  workflow_dispatch:

jobs:
  desktop-access:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: Fast & Silent Desktop Install
        run: |
          # 1. Force non-interactive mode and skip service restart prompts
          export DEBIAN_FRONTEND=noninteractive
          export NEEDRESTART_MODE=a 
          
          sudo apt-get update
          
          # 2. Install only the essentials for a desktop experience (Fast Mode)
          # --no-install-recommends prevents downloading hundreds of unnecessary drivers
          sudo apt-get install -y --no-install-recommends \
            ubuntu-desktop-minimal \
            xrdp \
            gnome-terminal \
            dbus-x11

          # 3. Fix RDP Permissions silently
          sudo adduser xrdp ssl-cert
          
          # 4. Suppress Polkit pop-ups (prevents RDP freeze)
          sudo bash -c 'cat > /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla <<EOF
          [Allow Colord Manager]
          Identity=unix-user:*
          Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
          ResultAny=no
          ResultInactive=no
          ResultActive=yes
          EOF'

      - name: Create User (Rayat)
        run: |
          sudo useradd -m -s /bin/bash Rayat
          sudo usermod -aG sudo Rayat
          echo "Rayat:password123" | sudo chpasswd
          
          # Set GNOME as default for this user
          echo "export GNOME_SHELL_SESSION_MODE=ubuntu" > ~/.xsessionrc
          echo "export XDG_CURRENT_DESKTOP=ubuntu:GNOME" >> ~/.xsessionrc
          echo "export XDG_SESSION_TYPE=x11" >> ~/.xsessionrc
          sudo cp ~/.xsessionrc /home/Rayat/.xsessionrc
          sudo chown Rayat:Rayat /home/Rayat/.xsessionrc

      - name: Network & Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=ubuntu-gui
          
      - name: Launch & Maintain
        run: |
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          echo "=== CONNECT NOW ==="
          tailscale ip -4
          tail -f /dev/null
