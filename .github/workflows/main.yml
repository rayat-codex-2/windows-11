name: Ubuntu Fast RDP

on:
  workflow_dispatch:

jobs:
  desktop-access:
    runs-on: ubuntu-latest
    steps:
      - name: Silent Install Essentials
        run: |
          export DEBIAN_FRONTEND=noninteractive
          # Tell needrestart to be quiet and just do it
          sudo apt-get update
          sudo apt-get install -y -q --no-install-recommends \
            xfce4 xfce4-goodies xrdp dbus-x11

      - name: Configure User & XRDP
        run: |
          # Create user Rayat
          sudo useradd -m -s /bin/bash Rayat
          echo "Rayat:password123" | sudo chpasswd
          sudo usermod -aG sudo Rayat
          
          # Setup XFCE for RDP (This bypasses GDM entirely)
          echo "xfce4-session" > /home/Rayat/.xsession
          sudo chown Rayat:Rayat /home/Rayat/.xsession
          
          # Force XRDP to use the .xsession file
          sudo sed -i 's/test -x \/etc\/X11\/Xsession \&\& exec \/etc\/X11\/Xsession/exec startxfce4/g' /etc/xrdp/startwm.sh
          
          sudo adduser xrdp ssl-cert
          sudo systemctl restart xrdp

      - name: Tailscale & Finalize
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key=$TS_KEY --hostname=fast-ubuntu
          
          echo "=== CONNECTION INFO ==="
          tailscale ip -4
          tail -f /dev/null
