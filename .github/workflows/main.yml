name: Ubuntu Desktop Remote

on:
  workflow_dispatch:

jobs:
  desktop-access:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: Install Ubuntu Desktop (GNOME)
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          # Install the standard Ubuntu Desktop and RDP server
          sudo apt-get install -y ubuntu-desktop xrdp
          
          # Fix for GNOME sessions over RDP
          sudo sed -i 's/allowed_users=console/allowed_users=anybody/' /etc/X11/Xwrapper.config
          
          # Prevent the 'Authentication Required' pop-ups on login
          sudo bash -c 'cat > /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla <<EOF
          [Allow Colord Manager]
          Identity=unix-user:*
          Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
          ResultAny=no
          ResultInactive=no
          ResultActive=yes
          EOF'

      - name: Create User (Rayat)
        run: |
          sudo useradd -m -s /bin/bash Rayat
          sudo usermod -aG sudo Rayat
          # Set a default password because GNOME Keyring requires one to function properly
          echo "Rayat:password123" | sudo chpasswd
          
          # Set the session to GNOME
          echo "export GNOME_SHELL_SESSION_MODE=ubuntu" | sudo tee /home/Rayat/.xsessionrc
          echo "export XDG_CURRENT_DESKTOP=ubuntu:GNOME" | sudo tee -a /home/Rayat/.xsessionrc
          echo "export XDG_SESSION_TYPE=x11" | sudo tee -a /home/Rayat/.xsessionrc
          sudo chown Rayat:Rayat /home/Rayat/.xsessionrc

      - name: Install Tailscale
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          sudo tailscale up --auth-key=${TAILSCALE_AUTHKEY} --hostname=ubuntu-gui-$GITHUB_RUN_ID
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> $env:GITHUB_ENV # Note: used $env: for consistency with your flow

      - name: Start Services
        run: |
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          # Ensure the firewall allows RDP
          sudo ufw allow 3389/tcp

      - name: Maintain Connection
        run: |
          TS_IP=$(tailscale ip -4)
          echo "=== UBUNTU DESKTOP READY ==="
          echo "Address: $TS_IP"
          echo "Username: Rayat"
          echo "Password: password123"
          tail -f /dev/null
